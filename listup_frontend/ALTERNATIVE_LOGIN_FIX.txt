// ALTERNATIVE LOGIN FIX
// Replace the attemptLogin and handleSubmit functions in src/app/login/page.tsx with this:

import api from "@/utils/axios"; // Add this import at the top

// Replace the attemptLogin function with this version:
const attemptLogin = async () => {
  setLoading(true);
  setError("");
  setSuccess("");

  try {
    // Call API directly instead of through auth store
    const response = await api.post("/auth/login", { 
      email: email.trim(), 
      password 
    });

    console.log("Login response:", response);

    // Check if login was successful
    if (response.data.success && response.data.data) {
      const { token, user: userData } = response.data.data;
      
      // Save to localStorage
      localStorage.setItem("token", token);
      localStorage.setItem("id", userData.id);
      localStorage.setItem("name", userData.name);
      localStorage.setItem("email", userData.email);
      localStorage.setItem("role", userData.role);
      if (userData.phone) localStorage.setItem("phone", userData.phone);
      
      // Update Zustand store
      const user = {
        id: userData.id,
        name: userData.name,
        email: userData.email,
        role: userData.role.toUpperCase() as "USER" | "VENDOR",
        phone: userData.phone,
        token,
        ...(userData.vendorProfile && {
          vendorProfile: userData.vendorProfile
        })
      };
      
      // Use setAuth to update the store
      useAuthStore.getState().setAuth(user);
      
      setSuccess("Login successful! Redirecting to dashboard...");
      
      // Redirect after showing success message
      setTimeout(() => {
        router.push("/dashboard");
      }, 2000);
      
    } else {
      // API returned but login failed
      const errorMessage = response.data.message || "Invalid email or password";
      setError(errorMessage);
    }
    
  } catch (error: any) {
    console.error("Login error:", error);
    
    // Extract error message from various possible locations
    let message = "Unable to login. Please try again.";
    
    if (error?.response?.data?.message) {
      message = error.response.data.message;
    } else if (error?.response?.data?.error) {
      message = error.response.data.error;
    } else if (error?.message) {
      message = error.message;
    } else if (error?.response?.status === 401) {
      message = "Invalid email or password";
    } else if (error?.response?.status === 403) {
      message = "Access denied. Please check your credentials.";
    } else if (error?.response?.status >= 500) {
      message = "Server error. Please try again later.";
    }
    
    setError(message);
    setFieldErrors({});
    
  } finally {
    setLoading(false);
  }
};

// Replace the handleSubmit function with this version:
const handleSubmit = async (e: React.FormEvent) => {
  // Prevent default form submission
  e.preventDefault();
  e.stopPropagation();
  
  // Call attemptLogin
  await attemptLogin();
  
  // Return false to prevent any default behavior
  return false;
};

// ALSO UPDATE THE FORM ELEMENT:
// Change the form opening tag to:
<form 
  onSubmit={handleSubmit}
  action="#"
  method="post"
  className="relative z-10 bg-white p-8 rounded-2xl shadow-lg w-full max-w-md border border-slate-200/20"
>

// MAKE SURE THE BUTTON HAS type="submit":
<button
  type="submit"
  disabled={loading}
  className="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-lime-400 px-4 py-3 text-sm font-semibold text-slate-900 shadow-[inset_0_-2px_0_rgba(0,0,0,0.15)] transition hover:-translate-y-0.5 hover:bg-lime-300 focus:outline-none focus:ring-4 focus:ring-lime-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0"
>
  {loading ? (
    <>
      <RefreshCw className="h-4 w-4 animate-spin" />
      Logging in...
    </>
  ) : (
    <>
      Login
      <ArrowRight className="h-4 w-4" />
    </>
  )}
</button>
